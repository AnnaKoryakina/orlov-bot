# bot_orlov.py
import os
import random
import asyncio
from collections import deque
from datetime import time, datetime
from zoneinfo import ZoneInfo

from telegram import Update
from telegram.constants import ChatAction
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    JobQueue,
    filters,
)


SARCASM_LEVEL = 2          
MAX_WRONG_STREAK = 2       # –ø–æ—Å–ª–µ N –ø–æ–¥—Ä—è–¥ –Ω–µ–≤–µ—Ä–Ω—ã—Ö ‚Äî —Å—Ç–µ–±)))))

# —Ä–µ–ø–ª–∏–∫–∏ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∂–∏–≤–æ—Ç–∏, –Ω–µ –∑–∞–±—ã—Ç—å –ø–æ–º–µ–Ω—è—Ç—å –≤—Ä–µ–º—è –Ω–∞ 15 –º–∏–Ω—É—Ç

IDLE_REPLIES = [
  
    "–°–ª–∏—à–∫–æ–º —Ç–∏—Ö–æ –≤–æ–∫—Ä—É–≥... –î–µ—Ä–∂–∏ —É—Ö–æ –≤–æ—Å—Ç—Ä–æ.",
    "–Ø —Ç—É—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–ª –¥–æ—Å—å–µ –µ—â—ë —Ä–∞–∑ ‚Äî –∫–æ–µ-—á—Ç–æ –Ω–µ –¥–∞—ë—Ç –ø–æ–∫–æ—è.",
    "–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ —Å–ø–µ—à–∏. –û—à–∏–±–∫–∏ –Ω–∞–º —Å–µ–π—á–∞—Å –Ω–∏ –∫ —á–µ–º—É.",
    "–•–º... –∏–Ω–æ–≥–¥–∞ –¥—É–º–∞—é, —á—Ç–æ —É –Ω–∞—Å –≤ –æ—Ç–¥–µ–ª–µ —Ç–æ–∂–µ –µ—Å—Ç—å –∫—Ä—ã—Å–∞. –ù–æ —ç—Ç–æ –ø–æ—Ç–æ–º.",
    
    "–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∑–∞–º–µ—Ç–∏—à—å —Ö–≤–æ—Å—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∏–º –±—É–ª–æ—á–∫—É. –û–±—ã—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.",
    "–í —à—Ç–∞–±–µ –∫–æ—Ñ–µ —Å–Ω–æ–≤–∞ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è‚Ä¶ –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –¥–∏–≤–µ—Ä—Å–∏—è.",
    "–¢—ã –Ω–µ –ø–æ–≤–µ—Ä–∏—à—å, –Ω–æ –¥–∞–∂–µ –Ω–∞—à–∞ –∫—Ä—ã—Å–∞ –æ–ø–∞–∑–¥—ã–≤–∞–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É.",
    "–ë—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω. –í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –∞–≥–µ–Ω—Ç —á—É—Ç—å –Ω–µ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è –∏–∑-–∑–∞ –∫–æ—Ç–∞. –°–µ—Ä—å–µ–∑–Ω–æ.",
    "–ì–æ–≤–æ—Ä—è—Ç, —Å–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ ‚Äî —ç—Ç–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞. –ù–æ —è –≤—Å—ë –∂–µ –∑–∞ —Ö–æ—Ä–æ—à–∏–π –∫–æ—Ñ–µ.",
    "–°–µ–≥–æ–¥–Ω—è –≤ —Å—Ç–æ–ª–æ–≤–æ–π —Å–Ω–æ–≤–∞ –±–æ—Ä—â —Ä–∞–∑–≤–µ–¥–¥–∞–Ω–Ω—ã—Ö. –ö–∏—Å–ª—ã–π, –Ω–æ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π.",
    "–ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏—à—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –≤–µ–∂–ª–∏–≤–æ–≥–æ –≥–æ–ª—É–±—è ‚Äî —à–∏—Ñ—Ä—É–π—Å—è. –ú—ã —Ç–∞–∫–∏—Ö –∑–Ω–∞–µ–º.",
    "–û—Ç–¥—ã—à–∏—Å—å –∏ –ø—Ä–æ–≤–µ—Ä—å –¥–æ–∫—É–º–µ–Ω—Ç—ã. –î—ã—à–∞—Ç—å –º–æ–∂–Ω–æ, –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å ‚Äî –Ω–µ–ª—å–∑—è.",
]

# –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å —Å–º–µ—à–Ω—ã–µ
WRONG_REPLIES = [
    "–ü—Ä–∏–Ω—è—Ç–æ. –ù–æ –¥–∞–≤–∞–π-–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã. –≠—Ç–æ —è–≤–Ω–æ –Ω–µ –∑–∞—Ü–µ–ø–∫–∞. –ñ–¥—É –æ—Ç —Ç–µ–±—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —á–µ–º-—Ç–æ –¥–µ–ª—å–Ω—ã–º.",
    "–ü—Ä–∏–Ω—è–ª, –Ω–æ —ç—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –ø–æ –¥–µ–ª—É.",
    "–ù–µ –æ—Ç–≤–ª–µ–∫–∞–π –º–µ–Ω—è, –∞–≥–µ–Ω—Ç. –ù—É–∂–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞—Ü–µ–ø–∫–∏, –∞ –Ω–µ –±–æ–ª—Ç–æ–≤–Ω—è.",
    "–•–º‚Ä¶ –µ—Å–ª–∏ —ç—Ç–æ —à–∏—Ñ—Ä, —Ç–æ –¥–∞–∂–µ –Ω–∞—à –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏–∑ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ –µ–≥–æ –Ω–µ –ø–æ–Ω—è–ª.",
    "–ê–≥–µ–Ω—Ç, —É –º–µ–Ω—è —Å–∏–ª—å–Ω–æ–µ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ, —á—Ç–æ —Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–ª—É—á–∞–π–Ω–æ –Ω–∞–∂–∞–ª –Ω–µ —Ç–µ –∫–ª–∞–≤–∏—à–∏.",
    "–≠—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –∫–æ–¥. –ù–æ –µ—Å–ª–∏ –±—ã –±—ã–ª ‚Äî —è –±—ã –Ω–∞–∑–≤–∞–ª –µ–≥–æ ¬´–û–ø–µ—Ä–∞—Ü–∏—è –°–æ–≤—Å–µ–º –ù–µ –¢–æ¬ª.",
    "–ê–≥–µ–Ω—Ç, –µ—Å–ª–∏ —ç—Ç–æ —à–∏—Ñ—Ä, —Ç–æ –æ–Ω —è–≤–Ω–æ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –¥–µ—Ç—Å–∫–∏—Ö –∫—Ä–æ—Å—Å–≤–æ—Ä–¥–æ–≤.",
    "–ü–æ—Ö–æ–∂–µ –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä –±—É–∫–≤‚Ä¶ –∏–ª–∏ —É —Ç–µ–±—è –∫–æ—Ç –ø—Ä–æ—à—ë–ª—Å—è –ø–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ?",
    "–ü—Ä–∏–±–æ—Ä –º–æ–ª—á–∏—Ç. –ò —è —Ç–æ–∂–µ –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å. –î–∞–≤–∞–π –µ—â—ë —Ä–∞–∑, –Ω–æ –ø–æ –¥–µ–ª—É.",
    "–ü–æ—á—Ç–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å! –ï—Å–ª–∏ –±—ã –Ω–∞—à–∞ —Ü–µ–ª—å –±—ã–ª–∞ ‚Äî –∑–∞–ø—É—Ç–∞—Ç—å –û—Ä–ª–æ–≤–∞.",
    "–¢–∞–∫, —è –ø—Ä–æ–≤–µ—Ä–∏–ª‚Ä¶ –≠—Ç–æ –∫–æ–¥ –æ—Ç –º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∏. –ù–∞–º –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π.",
    "–ó–∞–ø–∏—Å–∞–ª. –û—Ç–ø—Ä–∞–≤–∏–ª –≤ –∞—Ä—Ö–∏–≤. –í –æ—Ç–¥–µ–ª —à—É—Ç–æ–∫.",
    "–£–≥—É. –ü–æ—Ö–æ–∂–µ –Ω–∞ –ø–∞—Ä–æ–ª—å –æ—Ç Wi-Fi. –ï—Å—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–≥–æ—Ä—è—á–µ–µ?",
    "–ö–æ–¥ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π. –ñ–∞–ª–∫–æ, –Ω–µ –Ω–∞—à.",
    "–ï—Å–ª–∏ —ç—Ç–æ –∑–æ–≤ –æ –ø–æ–º–æ—â–∏ ‚Äî –º–æ—Ä–≥–Ω–∏ –¥–≤–∞ —Ä–∞–∑–∞. –ï—Å–ª–∏ –∫–æ–¥ ‚Äî –Ω–∞–±–µ—Ä–∏ –µ—â—ë —Ä–∞–∑.",
    "–° —Ç–∞–∫–∏–º —à–∏—Ñ—Ä–æ–º —è —Ç–æ–ª—å–∫–æ —á–∞–π –º–æ–≥—É –∑–∞–≤–∞—Ä–∏—Ç—å. –î–∞–≤–∞–π –¥—Ä—É–≥–æ–µ.",
    # –ß—É—Ç—å –µ—Ö–∏–¥–Ω–µ–µ
    "–°–º–µ–ª–æ. –ù–µ–≤–µ—Ä–Ω–æ ‚Äî –Ω–æ —Å–º–µ–ª–æ. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ, —Ç–æ–ª—å–∫–æ –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∞—á–∏–Ω–∞–π.",
    "–î–∞–≤–∞–π —Ç–∞–∫: —Ç—ã ‚Äî –µ—â—ë —Ä–∞–∑ –ø—Ä–æ–±—É–µ—à—å, —è ‚Äî –¥–µ–ª–∞—é –≤–∏–¥, —á—Ç–æ –Ω–µ –≤–∏–¥–µ–ª —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.",
]

# –¥–ª–∏–Ω–Ω—ã–µ —á—Ç–æ–±—ã —è–∑—ã–∫ –±—ã–ª –∂–∏–≤–µ–µ
LONG_WRONG_REPLIES = [
    "–°–ª—É—à–∞–π‚Ä¶ –∏–Ω–æ–≥–¥–∞ –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –≤—Å–µ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –±–æ–ª—å—à–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —à–∞—Ö–º–∞—Ç–Ω—É—é –ø–∞—Ä—Ç–∏—é. "
    "–•–æ–¥—ã –ø—Ä–æ–¥—É–º–∞–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ, –∞ –º—ã –ª–∏—à—å –ø–µ—à–∫–∏. –ù–æ –ø–µ—à–∫–∞ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –¥–æ–π—Ç–∏ –¥–æ –∫–æ–Ω—Ü–∞ –¥–æ—Å–∫–∏ –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Ñ–µ—Ä–∑—è. "
    "–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ —Å–¥–∞—Ç—å—Å—è —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.",
    "–ó–Ω–∞–µ—à—å, –∞–≥–µ–Ω—Ç‚Ä¶ –∑–∞ 20 –ª–µ—Ç —Å–ª—É–∂–±—ã —è –ø–æ–Ω—è–ª –æ–¥–Ω—É –≤–µ—â—å: —Å–∞–º—ã–µ –ø—Ä–æ—Å—Ç—ã–µ –º–µ–ª–æ—á–∏ –∏–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç –¥–µ–ª–æ. "
    "–û–¥–Ω–∞ –∑–∞–ø–∏—Å–∫–∞, –æ–¥–Ω–∞ –∑–∞–±—ã—Ç–∞—è –∫–≤–∏—Ç–∞–Ω—Ü–∏—è, –æ–¥–Ω–∞ —Å–ª—É—á–∞–π–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞. –¢–∞–∫ —á—Ç–æ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –¥–µ—Ç–∞–ª–∏.",
    "–ö–æ–≥–¥–∞ —è –±—ã–ª –Ω–∞ –∑–∞–¥–∞–Ω–∏–∏ –≤ 2007, –≤—Å—ë –ø–æ—à–ª–æ –∫ —á–µ—Ä—Ç—É. –°–≤—è–∑—å –æ–±–æ—Ä–≤–∞–ª–∞—Å—å, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ—Ç–µ—Ä—è–ª–∏—Å—å. "
    "–ù–æ –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–Ω–∞—è –Ω–∞–¥–ø–∏—Å—å –Ω–∞ —Å—Ç–µ–Ω–µ –≤—ã–≤–µ–ª–∞ –Ω–∞—Å –Ω–∞ —Ü–µ–ª—å. –¢–∞–∫ —á—Ç–æ, –µ—Å–ª–∏ —É–≤–∏–¥–∏—à—å —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ ‚Äî –ª—É—á—à–µ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π.",
]

# –ö–æ–¥—ã 
CODES = {
    "777": (
        "–ï—Å—Ç—å –∑–∞—Ü–µ–ø–∫–∞! –û—Ç–ø—Ä–∞–≤–ª—è–π—Å—è –ø–æ —ç—Ç–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º "
        "55.901840, 37.713295.\n\n"
        "–¢–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–±—ã—Ç—å –Ω–∞ –º–µ—Å—Ç–æ –¥–æ 10:00, —ç—Ç–æ –ø–æ—á–µ–º—É-—Ç–æ –≤–∞–∂–Ω–æ. "
        "–ë–µ—Ä–∏ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞ –∏ –≤—ã–µ–∑–∂–∞–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ –∏–º–µ–Ω–∞, "
        "—è –ø–æ–∑–∞–±–æ—á—É—Å—å –æ –ø—Ä–∏–∫—Ä—ã—Ç–∏–∏. –í–∞–∂–Ω–æ —á—Ç–æ–±—ã –Ω–∏ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ, "
        "–Ω–∏ –±—é—Ä–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–æ–¥–æ–∑—Ä–∏–ª–∏. –£–¥–∞—á–∏."
    ),
    "–∫—É–∫—É—Ä—É–∑–Ω–∏–∫": (
        "–í–µ—Ä–Ω–æ! –í–æ—Ç –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Å—Ä–æ—á–Ω–æ –ø–æ —Å–ª–µ–¥—É! "
        "55.908373, 37.722586.\n\n"
        "–¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –ø—Ä–∏–±–æ—Ä—á–∏–∫ –ø—Ä–æ—Å–∏—Ç –¥–ª–∏–Ω–Ω—ã–π –∫–æ–¥‚Ä¶ 11 —Ü–∏—Ñ—Ä‚Ä¶ –∏–ª–∏ –±—É–∫–≤? –ö–∞–∫ –∑–Ω–∞—Ç—å."
    ),
    "89853019911": (
        "–•–æ—Ä–æ—à–æ! –û—Ç–ª–∏—á–Ω–æ! –¢—ã –≤—Å–µ –±–ª–∏–∂–µ! "
        "55.911976,37.716748.\n\n"
        "–ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –≤—Å–µ–≥–æ 4 –±—É–∫–≤—ã –∏–ª–∏ —Ü–∏—Ñ—Ä—ã. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑ –ø–ª—é–Ω—É—Ç—å. "
        "–û—Å–æ–±–µ–Ω–Ω–æ —Ç–µ–±–µ."
    ),
    "1983": (
        "–§–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è, –∞–≥–µ–Ω—Ç! "
        "55.903291, 37.712059.\n\n"
        "–ù–æ –∑–¥–µ—Å—å –±—ã–ª–∞ –ø–æ–º–µ—Ç–æ—á–∫–∞: ¬´–≥–¥–µ-—Ç–æ —Ç—É—Ç, –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ—Ç–æ–º¬ª. "
        "–ö–∞–∂–µ—Ç—Å—è, –∫—Ç–æ-—Ç–æ –Ω–µ —É—Å–ø–µ–ª —É—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–æ—á–∫—É. –£–¥–∞—á–∏!"
    ),
    "—Ç–∞–π–Ω–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ": (
        "–ê–≥–∞‚Ä¶ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —Ç—ã –¥–µ–ª–æ –≤—ã–ø–æ–ª–Ω—è–µ—à—å, –∞–≥–µ–Ω—Ç‚Ä¶\n"
        "–õ–∞–¥–Ω–æ, –∫–∞–∂–µ—Ç—Å—è, —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –¢–µ–±–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –ø–∞–ø–∫—É. "
        "–ù–∞–º –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –æ–Ω —Å –∫–µ–º-—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–ª—Å—è –Ω–µ–ø–æ–¥–∞–ª–µ–∫—É.\n"
        "–ü–æ—á–∏—Ç–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Å—è –ø–æ —Å–ª–µ–¥—É.\n"
        "–ü–∏—à–∏, –∫–æ–≥–¥–∞ –±—É–¥—É—Ç –Ω–æ–≤—ã–µ –∑–∞—Ü–µ–ø–∫–∏."
    ),
    "–ø–∞—Ä–∫": (
        "–ö–∞–∂–µ—Ç—Å—è —Ç—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –º–µ—Å—Ç–µ. –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —à—Ç—É–∫–æ–≤–∏–Ω–∞ –ø—Ä–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: "
        "¬´–ö–∞–∫–æ–π —Å–∞–º–æ–ª–µ—Ç –≤—ã–±–µ—Ä–µ—à—å?¬ª –ï—Å—Ç—å –∏–¥–µ–∏?"
    ),
    "–±—É–ª—å–≤–∞—Ä": (
        "–ö–∞–∂–µ—Ç—Å—è —Ç—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –º–µ—Å—Ç–µ. –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —à—Ç—É–∫–æ–≤–∏–Ω–∞ –ø—Ä–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: "
        "¬´–ö–∞–∫–æ–π —Å–∞–º–æ–ª–µ—Ç –≤—ã–±–µ—Ä–µ—à—å?¬ª –ï—Å—Ç—å –∏–¥–µ–∏?"
    ),
    "–±—É–ª—å–≤–∞—Ä –≤–µ—Ç–µ—Ä–∞–Ω–æ–≤": (
        "–ö–∞–∂–µ—Ç—Å—è —Ç—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –º–µ—Å—Ç–µ. –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —à—Ç—É–∫–æ–≤–∏–Ω–∞ –ø—Ä–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: "
        "¬´–ö–∞–∫–æ–π —Å–∞–º–æ–ª–µ—Ç –≤—ã–±–µ—Ä–µ—à—å?¬ª –ï—Å—Ç—å –∏–¥–µ–∏?"
    ),
}

# –û—Å–æ–±—ã–µ  –æ—Ç–≤–µ—Ç—ã
SPECIAL_FUNNY = {
    "—Å–∞–º–æ–ª–µ—Ç": "–°–∞–º–æ–ª—ë—Ç? –°–µ—Ä—å–µ–∑–Ω–æ? –ì–µ–Ω–∏–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≥–µ–Ω–∏–∞–ª—å–Ω–æ. –î—É–º–∞–π –µ—â—ë",
    "—Ç–æ—Ä—Ç": "–¢–æ—Ä—Ç ‚Äî —ç—Ç–æ —Å–≤—è—Ç–æ–µ. –ù–æ —É–ª–∏–∫–∞–º –Ω—É–∂–Ω–µ–µ –∫—Ä–æ—à–∫–∏, —á–µ–º –Ω–∞–º –∫–∞–ª–æ—Ä–∏–∏ üéÇ",
    "–Ω–µ –∑–Ω–∞—é": "–§—Ä–∞–∑–∞, –¥–æ—Å—Ç–æ–π–Ω–∞—è –æ—Ç—á—ë—Ç–∞. –ù–æ –¥–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º ¬´—É–∑–Ω–∞—é¬ª üòâ",
    "–Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å": "–ü–æ–º–æ—â—å —É–∂–µ –≤—ã–µ—Ö–∞–ª–∞‚Ä¶ –Ω–∞ –ª–æ—à–∞–¥–∏. –ú–æ–∂–µ—Ç, –ø–æ–∫–∞ —Å–∞–º —Å–ø—Ä–∞–≤–∏—à—å—Å—è?",
    "—Ç—É": "¬´–¢—É-—Ç—É—É—É¬ª ‚Äî —ç—Ç–æ, –∫–æ–Ω–µ—á–Ω–æ, –ª–æ–∫–æ–º–æ—Ç–∏–≤. –ù–æ –º—ã –≤—Å—ë-—Ç–∞–∫–∏ –∞–≥–µ–Ω—Ç—ã, –∞ –Ω–µ –º–∞—à–∏–Ω–∏—Å—Ç—ã üöÇ",
    "—Å–ø–∞": "–°–ü–ê? –°–µ—Ä—å–µ–∑–Ω–æ? –ü—Ä–æ—Ö–ª–∞–∂–¥–∞–µ—à—å—Å—è, –∞–≥–µ–Ω—Ç? –ê –Ω—É —Ä–∞–±–æ—Ç–∞—Ç—å!",
}

# –û—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ—Ñ–µ
COFFEE_OK_WORDS = {"–Ω–æ—Ä–º–∞–ª—å–Ω–æ", "–≤–∫—É—Å–Ω—ã–π", "—Ö–æ—Ä–æ—à–∏–π", "–Ω–µ–ø–ª–æ—Ö–æ–π"}
COFFEE_JOKES = [
    "–û—Ç–ª–∏—á–Ω–æ. –ö–æ—Ñ–µ–∏–Ω –ø—Ä–∏–Ω—è—Ç, –º–æ–∑–≥–∏ –≤ —Å—Ç—Ä–æ–π! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –¥–µ–ª—É, –∞–≥–µ–Ω—Ç.",
    "–ó–∞–ø–∏—Å—ã–≤–∞—é –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª: –∫–æ—Ñ–µ –≥–æ–¥–µ–Ω. –ê —Ç–µ–ø–µ—Ä—å ‚Äî –Ω–æ–≥–∏ –≤ —Ä—É–∫–∏ –∏ –≤–ø–µ—Ä—ë–¥!",
    "–ö–æ—Ñ–µ —Ö–æ—Ä–æ—à–∏–π ‚Äî –æ—Ç–º–∞–∑–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –í–∫–ª—é—á–∞–π —Ä–µ–∂–∏–º ¬´—Å–æ–∫–æ–ª¬ª.",
    "–ü—Ä–∏–Ω—è—Ç–æ. –ï—Å–ª–∏ —Å–µ—Ä–¥—Ü–µ –Ω–µ –ø—Ä—ã–≥–∞–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, –º–æ–∂–Ω–æ –ø—Ä—ã–≥–∞—Ç—å –≤ —Ä–∞–±–æ—Ç—É.",
    "–í–∫—É—Å–Ω—ã–π? –¢–æ–≥–¥–∞ –Ω–µ—Å–∏ –µ—â—ë –∑–∞—Ü–µ–ø–∫–∏. –ò –º–Ω–µ –∫–∞–ø—É—á–∏–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ.",
]

# –¥–æ–ø —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç—ã
def sarcasm_on() -> bool:
    return SARCASM_LEVEL >= 2

def time_snark() -> str:
    h = datetime.now().hour
    if 0 <= h < 5:
        return "–ù–æ—á–Ω–æ–π –¥–æ–∑–æ—Ä, –∑–Ω–∞—á–∏—Ç? –õ–∞–¥–Ω–æ. –°–º–æ—Ç—Ä–∏ –Ω–µ —É—Å–Ω–∏ –Ω–∞ —Ö–≤–æ—Å—Ç–µ."
    if 5 <= h < 9:
        return "–†–∞–Ω–Ω–∏–π —Å—Ç–∞—Ä—Ç. –£–≤–∞–∂–∞—é. –ò–ª–∏ –∫–æ—Ñ–µ —Å–ª–∏—à–∫–æ–º –∫—Ä–µ–ø–∫–∏–π?"
    if 22 <= h < 24:
        return "–ü–æ–∑–¥–Ω–æ–≤–∞—Ç–æ –¥–ª—è –≥–µ—Ä–æ–∏–∑–º–∞, –Ω–æ –∫—Ç–æ —è —Ç–∞–∫–æ–π, —á—Ç–æ–±—ã –º–µ—à–∞—Ç—å."
    return ""

async def type_then_reply(message, text: str, delay: float = 0.4):
    try:
        await message.chat.send_action(ChatAction.TYPING)
    except Exception:
        pass
    await asyncio.sleep(delay)
    await message.reply_text(text)

def choose_no_recent(options: list[str], history: deque, keep_last: int = 3) -> str:
    """–í—ã–±–æ—Ä —Ñ—Ä–∞–∑—ã, –∏–∑–±–µ–≥–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö keep_last –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤."""
    recent = set(list(history)[-keep_last:]) if history else set()
    pool = [o for o in options if o not in recent]
    if not pool:
        history.clear()
        pool = options[:]
    pick = random.choice(pool)
    history.append(pick)
    while len(history) > keep_last:
        history.popleft()
    return pick

# –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# –ê–≤—Ç–æ-—Ä–µ–ø–ª–∏–∫–∏ (–∫–∞–∂–¥—ã–µ 15‚Äì30 –º–∏–Ω)
async def send_idle_message(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    chat_data = context.chat_data
    idle_hist: deque = chat_data.setdefault("idle_hist", deque(maxlen=3))
    reply = choose_no_recent(IDLE_REPLIES, idle_hist, keep_last=3)
    try:
        await context.bot.send_message(job.chat_id, reply)
    except Exception:
        return
    delay = random.randint(900, 1800)  
    context.job_queue.run_once(send_idle_message, delay, chat_id=job.chat_id)

# Follow-up –ø–æ—Å–ª–µ 777 (10 –º–∏–Ω!)
async def followup_after_777(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    try:
        await context.bot.send_message(
            job.chat_id,
            "–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞–∫–æ–Ω—á–∏—à—å –æ—Å–º–æ—Ç—Ä —Ç–æ—á–∫–∏ –Ω–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ —Ç–∞–º –Ω–∞–π–¥–µ—à—å. "
            "–í–≤–µ–¥—É —ç—Ç–æ –≤ –ø—Ä–∏–±–æ—Ä, –∞–≤–æ—Å—å —á—Ç–æ-—Ç–æ –ø–æ–∫–∞–∂–µ—Ç."
        )
    except Exception:
        return

# Follow-up –ø–æ—Å–ª–µ ¬´—Ç–∞–π–Ω–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ¬ª (20 –º–∏–Ω!) –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫ —á—Ç–æ–±—ã –±–æ–ª—Ç–æ–≤–Ω—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∞ –∫–≤–µ—Å—Ç
async def followup_after_secret_meeting(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    try:
        await context.bot.send_message(
            job.chat_id,
            "–ú—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏, —á—Ç–æ –æ–Ω —Å –∫–µ–º-—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–ª—Å—è. –ù—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å –≥–¥–µ. "
            "–ö–æ–≥–¥–∞ –≤—ã—è—Å–Ω–∏—à—å, –∫—É–¥–∞ –æ–Ω –ø—Ä–∏—à–µ–ª –Ω–∞ –≤—Å—Ç—Ä–µ—á—É ‚Äî –¥–∞–π –∑–Ω–∞—Ç—å."
        )
    except Exception:
        return

# –ö–û–§–ï: –ø–∏–Ω–≥ –≤ 11:47 –ú–°–ö
async def send_coffee_ping(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    context.chat_data["awaiting_coffee_reply"] = True
    # —Å–±—Ä–æ—Å –æ–∂–∏–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
    context.job_queue.run_once(clear_coffee_flag, when=1800, chat_id=job.chat_id)
    try:
        await context.bot.send_message(job.chat_id, "–ù—É –∫–∞–∫ –∫–æ—Ñ–µ–µ–∫?")
    except Exception:
        return

async def clear_coffee_flag(context: ContextTypes.DEFAULT_TYPE):
    context.chat_data["awaiting_coffee_reply"] = False

def schedule_daily_jobs(chat_id: int, context: ContextTypes.DEFAULT_TYPE):
    # —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –∫–æ—Ñ–µ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    name = f"coffee_{chat_id}"
    for j in context.job_queue.get_jobs_by_name(name):
        j.schedule_removal()
    # –ø–ª–∞–Ω –Ω–∞ 11:47 –ø–æ –ú–æ—Å–∫–≤–µ
    moscow = ZoneInfo("Europe/Moscow")
    context.job_queue.run_daily(
        send_coffee_ping,
        time=time(hour=11, minute=47, tzinfo=moscow),
        chat_id=chat_id,
        name=name,
    )

# ----------------- –•–ï–ù–î–õ–ï–†–´ -----------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    await update.message.reply_text(
        "–ú–∞–π–æ—Ä –û—Ä–ª–æ–≤ –Ω–∞ —Å–≤—è–∑–∏. –†–∞–¥ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è, –∞–≥–µ–Ω—Ç.\n"
        "–í–≤–æ–¥–∏ –∫–æ–¥—ã –∏–ª–∏ –¥–æ–∫–ª–∞–¥—ã–≤–∞–π. –Ø –ø—Ä–æ–≤–µ—Ä—é –∏ –¥–∞–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."
    )
    # –ª—ë–≥–∫–∞—è –µ—Ö–∏–¥–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
    extra = time_snark()
    if sarcasm_on() and extra:
        await type_then_reply(update.message, extra, delay=0.2)

    # –∞–≤—Ç–æ-—Ä–µ–ø–ª–∏–∫–∏ (—á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç) –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–æ—Ñ–µ–π–Ω—ã–π –ø–∏–Ω–≥
    context.job_queue.run_once(send_idle_message, 900, chat_id=chat_id)
    schedule_daily_jobs(chat_id, context)

async def router(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    text = (update.message.text or "").strip().lower()

    # –ö–æ—Ñ–µ ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç?
    if context.chat_data.get("awaiting_coffee_reply"):
        if text in COFFEE_OK_WORDS:
            joke = random.choice(COFFEE_JOKES)
            if sarcasm_on():
                add = random.choice([
                    "–õ—é–±–∏—Ç–µ–ª—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤‚Ä¶ –õ–∞–¥–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –¥–µ–ª—É.",
                    "–ó–∞–ø–∏—Å—ã–≤–∞—é: –∫–æ—Ñ–µ –æ–∫, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞. –ü–æ–µ—Ö–∞–ª–∏.",
                    "–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –ø—Ä–µ–¥–ª–∞–≥–∞—é –∑–∞–º–µ–Ω–∏—Ç—å —Å–∞—Ö–∞—Ä –Ω–∞ —É–ª–∏–∫–∏."
                ])
                joke = f"{joke}\n{add}"
            await type_then_reply(update.message, joke)
            context.chat_data["awaiting_coffee_reply"] = False
            return
        # –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥—Ä—É–≥–æ–π ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if text in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–ø—Ä–∏–≤–µ—Ç!"]:
        await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –ù—É –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ! –Ø —É–∂–µ –∑–∞–∂–¥–∞–ª—Å—è. –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –∫–∞–∫ –¥–µ–ª–∞.")
        return

    # –û—Å–æ–±—ã–µ —Å–º–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    if text in SPECIAL_FUNNY:
        await type_then_reply(update.message, SPECIAL_FUNNY[text])
        return

    # –ö–æ–¥—ã –ª–µ–≥–µ–Ω–¥—ã
    if text in CODES:
        await type_then_reply(update.message, CODES[text])
        # —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Ä–∏—é –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤–µ—Ä–Ω–æ–º –∫–æ–¥–µ
        context.chat_data["wrong_streak"] = 0
        if text == "777":
            context.job_queue.run_once(followup_after_777, 600, chat_id=chat_id)
        if text == "—Ç–∞–π–Ω–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ":
            context.job_queue.run_once(followup_after_secret_meeting, 1200, chat_id=chat_id)
        return

    # –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥: —Å–µ—Ä–∏—è + 10% –¥–ª–∏–Ω–Ω—ã–π, –∏–Ω–∞—á–µ –∫–æ—Ä–æ—Ç–∫–∏–π/—à—É—Ç–ª–∏–≤—ã–π; –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
    wrong_hist: deque = context.chat_data.setdefault("wrong_hist", deque(maxlen=3))
    wrong_streak = context.chat_data.get("wrong_streak", 0)
    context.chat_data["wrong_streak"] = wrong_streak + 1

    if random.random() < 0.1:
        reply = choose_no_recent(LONG_WRONG_REPLIES, wrong_hist, keep_last=3)
    else:
        reply = choose_no_recent(WRONG_REPLIES, wrong_hist, keep_last=3)

    if sarcasm_on() and context.chat_data["wrong_streak"] >= MAX_WRONG_STREAK:
        reply += random.choice([
            "\n–ó–∞–ø–∏—à—É –≤ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ: ¬´—Ä–µ—à–∞–ª –¥–µ–ª–∞ –º–µ—Ç–æ–¥–æ–º —Ç—ã–∫–∞¬ª.",
            "\n–°–æ–≤–µ—Ç –¥–Ω—è: –∏–Ω–æ–≥–¥–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äî –¥—Ä—É–≥, –∞ –Ω–µ –≤—Ä–∞–≥.",
            "\n–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑. –ù–∞ —ç—Ç–æ—Ç —Ä–∞–∑ ‚Äî –±–µ–∑ —Ñ—Ä–∏—Å—Ç–∞–π–ª–∞."
        ])

    await type_then_reply(update.message, reply)

# ----------------- MAIN -----------------
def main():
    token = os.getenv("BOT_TOKEN", "8302376134:AAFlhYhpEe4tqfrlQvmLhdBK6ryJyCnWrYw")
    app = ApplicationBuilder().token(token).build()

    # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ JobQueue (–Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å None)
    if app.job_queue is None:
        jq = JobQueue()
        jq.set_application(app)
        jq.start()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, router))

    app.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()




